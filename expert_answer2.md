ありがとうございます。Cardano モバイルウォレット接続の 2024 年時点での実態調査および他チェーンとの比較について、包括的にリサーチを開始します。

技術実装状況、対応ウォレット、モバイル接続手段の実態、技術的制約、マーケット影響、そして将来の展望を含めて、詳細な技術報告書として日本語でご報告いたします。しばらくお待ちください。

# Cardano モバイル dApp-ウォレット間 P2P 接続の実現可能性分析

## CIP-45 の実装可能性評価

**概要:** Cardano の CIP-45 は、モバイル環境で dApp とウォレット間の直接接続を実現する提案です。中央集権的なシグナリングサーバーを使う WalletConnect とは異なり、**WebRTC**と**WebTorrent トラッカー**を用いたピアツーピア接続によって、中央サーバーなしにウォレットと dApp を通信させます。この方式では、ウォレット RPC メソッド（CIP-30 API 相当）を dApp 側の`window.cardano`に注入することで、デスクトップ拡張と同様のインターフェースを提供します。

**実現性:** CIP-45 は 2022 年末に提案され現在**Status: Active**（承認済み）であり、既に複数の実装例があります。Cardano 財団の 2023 年サミット投票システム（Cardano Ballot）で CIP-45 が実証され、ユーザーは Eternl ウォレットの CIP-45 機能を使って投票サイトと P2P 接続しました。また分散型取引所 SundaeSwap によるデモ実装や、Cardano Foundation 提供の統合ライブラリ（**cardano-connect-with-wallet**）への組み込み、モバイルウォレット「WalkinWallet」での採用例も報告されています。これらの事例は、CIP-45 が実運用で利用可能な技術であることを示しています。

**対応ウォレットの現状:** モバイルアプリを持つ主要ウォレットのうち、**Eternl**はバージョン 1.11.0 以降で CIP-45（CardanoConnect）に対応済みです。Eternl 開発チームは「すべてを接続せよ！」として CIP-45 による分散型接続を公式にサポートし、dApp 開発者へ実装を呼びかけています。一方、**Yoroi**（エマーゴ社）についてはモバイル版で CIP-45 対応の公式発表がなく、現状では CIP-30（ブラウザ拡張/API）までのサポートに留まる可能性があります。その他、**Flint**や**GeroWallet**、**Tokeo**といったモバイル対応ウォレットは現時点で CIP-45 未対応ですが、今後のアップデートで対応する可能性があります（Flint は代替手段である WalletConnect の実装を優先しました）。モバイルアプリを持たない**Nami**や**Typhon**などは対象外です。

**実装の複雑さ:** 幸いにも、Fabian Bormann 氏（CIP-45 提案者）による公式の実装ライブラリ`@fabianbormann/cardano-peer-connect`が提供されており、CIP-30 の全機能を 100%サポートしています。このライブラリとデモ実装を活用すれば、ウォレット側・dApp 側双方の P2P 通信処理を抽象化でき、**2 ～ 4 週間の開発期間**で基本機能の構築は十分現実的です。実際に Cardano Foundation は同ライブラリを統合したコンポーネントを用意しており、環境判別の上でデスクトップでは従来の CIP-30、モバイルでは CIP-45 を透過的に扱えるよう設計されています。

**評価:** 以上を踏まえると、**CIP-45 方式の実装可能性は高い**と判断できます。既存ライブラリと実例が存在するため不確実性は低く、想定工数も 2〜3 人週程度（約 10 ～ 15 人日）で基本機能を実装可能でしょう。主なリスク要因は「一部ウォレット未対応によるユーザーカバレッジ低下」「P2P 接続特有の不確実性（後述）」ですが、技術的な障壁は限定的です。成功確率は概ね\*\*80〜90%\*\*と見込まれます（適切なテストとフォローアップを行えば十分達成可能な見込み）。

## モバイル P2P 接続の信頼性

**接続安定性:** WebRTC を用いた P2P 通信は、ブラウザとネイティブアプリ間で直接データチャネルを確立でき、高速かつエンドツーエンド暗号化された通信を提供します。Cardano Foundation の報告によれば、CIP-45 は**プライバシー保護と信頼性**を両立する方法として設計されており、中央サーバーに依存せずとも安定した接続が可能とされています。実際、2023 年の Cardano Ballot 実施時にも多数のユーザーがこの P2P 接続を利用し、大きな問題なく投票を完了しています。これらから、プロトコルレベルでは一定の信頼性が確認されています。

**アプリ切替時の挙動:** モバイル環境特有の課題として、ユーザーがブラウザ(dApp)とウォレットアプリを行き来する際の接続維持があります。CIP-45 では、初期ハンドシェイク時に**Universal Link/Deep Link**でウォレットを起動し、その間にブラウザ側は接続用の待受サーバー（Bugout/Meerkat ベース）を動かし続けます。懸念されるのは、**iOS で Safari がバックグラウンドに回った際に WebRTC 通信が停止する**可能性です。しかし CIP-45 提案時の検証では、**バックグラウンド状態のウォレットアプリが RPC コールに反応できるか**を iOS/Android 双方で重点テストしており、これらはクリアされています。つまり、ウォレット実装次第ではバックグラウンドからでも一定時間データチャネルを維持し、dApp からのリクエストに応答できることが確認済みです。Eternl など実装済みウォレットは、この点を考慮した処理（バックグラウンド動作許可や、一時的な接続維持）を行っていると考えられます。

もっとも、完全に不安要素がないわけではありません。モバイル OS はアプリ切替後しばらくするとリソースをスリープさせるため、**ユーザーには素早くブラウザに戻ってもらう**ことが望ましいです。接続確立自体は数秒程度で完了するケースが多いですが、万一時間がかかると iOS では接続失敗に陥るリスクがあります。このため、実装上は**ウォレット起動後一定時間内に dApp へ戻るよう促す UI**（例：「ウォレットで承認後、こちらの画面に戻ってください」等）を用意し、ユーザー誘導を行います。Android では比較的バックグラウンド動作に寛容ですが、iOS Safari はタブ自体が停止する場合もあるため、必要に応じてウォレット側から**Universal Link**でブラウザ復帰させる仕組みも検討します（CIP-45 のユーザーフロー図でも、必要に応じウォレットが前面復帰するシーケンスが示唆されています）。

**データ同期とセッション持続:** P2P 接続確立後、dApp 側からウォレット API（CIP-30 相当）を呼び出すことで最新 UTxO や残高情報を取得します。この通信は必要に応じ何度でも呼べるため、**リアルタイムに近いデータ取得**が可能です。例えばユーザーが別デバイスで ADA を追加受領した場合でも、再度`getUtxos()`を呼ぶことで最新 UTxO セットを取得できます。CIP-45 自体はイベントプッシュ機構を定めていませんが、dApp 側でポーリングしたりユーザー操作時に都度取得すれば実用上問題ありません。
セッションの維持については、一度接続が確立すれば基本的に**dApp⇔ ウォレット間のデータチャネルはオープンなまま**です。ユーザーがウォレットアプリから戻り dApp を操作している間も、バックグラウンドのウォレットは通信を保持します（少なくとも OS にキルされない限り）。長時間経過した場合や OS により接続が切断された場合は、dApp 側で RPC コール失敗を検知した時点でセッション切断とみなし、**再接続処理**（ユーザーに再度ウォレットを開いてもらう等）をトリガーする必要があります。セッション再開を円滑にするため、CIP-45 では**固定の識別子（Ed25519 公開鍵）**を用いており、一度ペアリングした dApp とウォレットは**同じ ID を使い続ける**ことができます。このため、ローカルにシードを保存しておけばページ再読み込み後でも同一ペアとして再接続可能で、ユーザーが毎回新しい QR コード/リンクを発行する手間を省けます。

**通信品質の課題:** WebRTC 通信は基本的に高速ですが、双方のネットワーク状況によっては**NAT 越え**や**遅延**の問題が起こり得ます。シグナリングに使う WebTorrent トラッカーが混雑・ダウンしている場合、ピア発見に時間がかかることも考えられます。CIP-45 では複数のパブリックトラッカーをリストし冗長化することで、この問題を緩和しています。それでも企業ネットワークや防火壁環境下では WebRTC 接続自体が阻害される可能性があります。成功率の目標値である**80%以上**は十分達成可能と予想しますが、残りの数十%の失敗ケースへのフォロー（後述の代替手段など）も考慮すべきです。

## ウォレットエコシステムとの互換性

**主対象ウォレット:** 現在モバイルアプリを提供している Cardano ウォレットのうち、本プロジェクトで主に対応検討するのは**Yoroi**と**Eternl**です（ユーザー数が多いため）。**Eternl**については前述の通り CIP-45 を公式サポート済みであり、実際に Cardano Ballot や複数の dApp で接続実績があります。**Yoroi**については、現在モバイル版で CIP-45 相当の機能は提供されていません。ただし Yoroi 開発元の Emurgo も CIP-30 を早期に実装した実績があり、モバイル連携ニーズは認識しているはずです。中長期的には Yoroi 側で CIP-45 または他のモバイル接続規格に対応する可能性がありますが、プロジェクトの 2-4 週という短期スパンでは**Yoroi ユーザーに対する直接的なソリューション**は存在しないのが現状です。そのため、**当面は Eternl 等の対応ウォレットを優先**し、Yoroi ユーザーには代替手段を案内する形になるでしょう。

**他ウォレットの状況:** 二次的対象の**Flint**, **GeroWallet**, **Tokeo**などもモバイルアプリを持ちます。これらのうち**Flint**は別アプローチとして**WalletConnect**方式の導入を進めており、2023 年に Catalyst 資金で Cardano 版 WalletConnect の開発が行われました。Flint モバイルはその成果として WalletConnect 経由で一部 dApp と接続可能になりつつあります。一方で CIP-45 への直接対応はまだ発表されていません。**GeroWallet**, **Tokeo**も CIP-45 未対応ですが、Eternl と同じライブラリを用いれば対応は技術的に難しくないため、将来的に追随する可能性はあります。**Lace**（公式新ウォレット）は現在デスクトップのみでモバイル未提供、**Typhon**や**Nami**もモバイル非対応ですので、これらは当面無視して問題ありません。

**CIP-30 互換性:** 重要な点として、CIP-45 方式で接続されたウォレットであっても、**dApp 側から見ると CIP-30 API がそのまま利用可能**です。つまり`api.getUtxos()`や`api.signTx()`等の呼び出し方はデスクトップの window\.cardano 拡張と同一です。これは開発の観点で大きなメリットであり、既存のデスクトップ実装（CIP-30）をそのまま流用できます。現行プロジェクトの React/TypeScript コードでも、環境判定して CIP-45 経由の wallet API を使うかどうか切り替えるだけで済むでしょう。実際、Cardano 財団提供のライブラリでは環境（モバイル/デスクトップ）によって裏側で CIP-45 接続を確立し、表向きは CIP-30 API を返す設計になっています。この互換性により、マルチプラットフォーム対応が容易になります。

**互換性に関するまとめ:** 現時点で CIP-45 によるモバイル連携が\*\*実用可能なのは Eternl（およびそれをベースにしたウォレット）\*\*と考えるべきです。他の主要ウォレットについては、WalletConnect 等の代替実装や将来の CIP-45 対応に備えつつも、短期的には Eternl ユーザーを中心に提供する戦略が現実的です。ユーザーには可能なら Eternl モバイルウォレットの利用を推奨し、どうしても Yoroi 等しか使えない場合は後述の代替策を案内する方針を取ります。また、本実装は既存の CIP-30 API と両立するため、**デスクトップ版（ブラウザ拡張経由）との二重対応**も問題なく共存できます。プラットフォーム毎に最適な接続方法をシームレスに選択できるよう、アプリケーションを調整していきます。

## 代替アプローチの評価

モバイル連携を実現する方法は CIP-45 以外にも考えられます。それぞれ利点と欠点、必要な労力を整理します。

- **① WalletConnect（カード版）**: Ethereum などで標準的な、モバイルウォレットとデスクトップ dApp を接続するプロトコルです。QR コードスキャン等でセッションを共有し、中央の中継サーバー（relay）経由でメッセージをやり取りします。Cardano では長らく公式サポートが無く、「WalletConnect は多くの dApp で統合されているが Cardano は未対応」という状況でした。そこで 2023 年前半に**Flint Wallet**チームが資金を得て Cardano 用 WalletConnect 拡張を開発し、現在 Flint や Eternl が**WalletConnect (v2)対応**を実現しています。

  - **メリット:** 他チェーン dApp でも一般的な UX であり、ユーザーが馴染みやすい。既存の WalletConnect インフラ（マルチプラットフォームな SDK やクラウド中継サーバー）が利用できるため、通信安定性や複数デバイス間接続（PC と携帯など）も担保されやすいです。中央サーバー依存とはいえ運用は WalletConnect 側に任せられるため、自前でインフラを構築する必要もありません。
  - **デメリット:** **中央集権的**である点が Cardano の分散志向に反します。中継サーバーが落ちれば接続不能になるシングルポイント・オブ・フェイル（SPOF）が存在します。また、Cardano 版 WalletConnect はまだ新しく標準規格化されていません。Flint/Eternl 実装はありますが、dApp 側で利用する SDK が整備されているかは不透明です。もし利用可能な SDK が無ければ、自前で WalletConnect プロトコル（複雑な暗号メッセージ交換とペイロード定義）を実装する必要があり、**2-4 週間では厳しい**でしょう。
  - **労力見積:** 仮に既存 SDK があり基本的なメソッドが使えるとしても、UI 部分（QR コード生成・セッション管理など）の実装や Cardano 固有メソッドの定義が必要です。少なく見積もって**3-4 週間以上**、CIP-45 より高コストです。

- **② サーバー中継型の独自実装:** WalletConnect に倣い、専用の中継サーバーを用意して dApp とウォレットがそこ経由で通信する方式です。たとえば dApp がバックエンドサーバーに取引要求を送り、モバイルウォレットが定期的にそのサーバーをポーリングして要求があれば処理・署名して返す、といったプロトコルを独自に設計する案です。

  - **メリット:** 技術的には**シンプル**です。WebRTC や複雑な P2P 処理を避けられるため、HTTP ベースで実装可能でデバッグもしやすいでしょう。サーバー側で状態管理できるため接続断のリトライや一時キューイングなども制御可能です。
  - **デメリット:** 中央サーバーが必要になり、**分散化の理念に反します**（WalletConnect と同様 SPOF になります）。またセキュリティ面で設計・監査すべき点が増えます（署名リクエストを改竄されないようにする等）。モバイルウォレットにもサーバーとの通信実装が必要で、ウォレット開発元との連携や許可が不可欠です。実質的に WalletConnect をゼロから自前開発するようなものであり、**実現ハードルは非常に高い**です。
  - **労力見積:** ウォレット側を改修できない場合は成立しないため、現実的ではありません。仮に独自ウォレットを用意するなら可能ですが、本プロジェクトの範囲を超えます。従って現実的な選択肢とは言えません。

- **③ ハイブリッドアプローチ:** 上記複数手段を組み合わせ、環境に応じて使い分ける戦略です。例えば\*\*「優先: CIP-45、代替: WalletConnect」**という二段構えを dApp 側で実装し、ユーザーに選択肢を与えることが考えられます。CIP-45 接続を試みて一定時間内に確立しなければ WalletConnect モードにフォールバックする、といった自動切替も可能でしょう。また将来的に**Lace ウォレット\*\*（IOG 製）など公式モバイルウォレットが登場した際には、そちらが独自方式を持っている可能性もあるため、それも統合する柔軟性を持たせることも含みます。

  - **メリット:** 一つの方法に固執しないため、ユーザーは環境や好みに応じて**接続手段を選べる**利点があります。ある手段が失敗しても他方で成功する可能性があり、全体の接続成功率向上が期待できます。特に WalletConnect は他チェーンでも一般的なので、マルチチェーン dApp ユーザーには受け入れやすいです。
  - **デメリット:** **実装と保守の負担**が倍増します。CIP-45 と WalletConnect では内部処理が全く異なるため、コードパスが分岐しバグの混入リスクも上がります。またユーザーに複数の接続オプションを提示すると混乱を招く可能性があります（UI/UX が複雑化）。フェールオーバーのロジックも慎重に設計しないと、想定外のタイミングで切り替わってかえってユーザー体験を損ねる恐れがあります。

- **④ カスタム Deep Link プロトコル:** ウォレットごとに固有の Deep Link URI スキームを用意し、dApp から直接取引データやコールバック URL を渡して処理させる方法です。例えば「`yoroi://sign?tx=<CBOR>&callback=https%3A%2F%2F...`」のような URL をブラウザから開かせ、ウォレットが署名後に指定のコールバック（例: dApp の特定 URL スキーム）を開く、という流れです。

  - **メリット:** **シンプル**で、WebRTC などを必要としません。各ウォレットが対応すれば即座に利用可能で、実装も深い統合は不要です。セキュリティ上も秘密鍵はウォレット内に留まり、戻ってくるのは署名済みトランザクションだけです。
  - **デメリット:** **標準規格が存在しない**ためウォレットごとに実装が異なり、dApp 側で個別対応が必要になります。現状、Cardano において統一された深いリンクプロトコルは CIP-30/45 以外にはなく、各ウォレットが独自行っている例もほぼありません。強いて言えば ccvault（現 Eternl）が過去に PWA モードで独自 JS ブリッジを実装していた程度です。この方法を取るにはウォレット開発元との緊密な協力が前提となり、本プロジェクト単独では実施困難です。ユーザー体験としても、複数段の画面遷移・アプリ切替が発生し煩雑です。

以上の評価から、本プロジェクトでは**まず CIP-45 の実装を主軸**とし、必要に応じて**WalletConnect とのハイブリッド**戦略を検討するのが妥当と考えられます。他の代替案は実効性・実現性の点で劣るため、優先度は低いでしょう。特に WalletConnect については Eternl も公式対応しており（上述）、ユーザーベースを広げるために将来的なオプションとして用意しておく価値があります。一方、CIP-45 自体が Cardano における公式なモバイル接続ソリューションとして期待されており\*\*（Eternl チームも CIP-45 採用を推奨）\*\*、まずはこちらの完成度を高めることが肝要です。

## 段階的な実装計画

本プロジェクトでは、機能をフェーズごとに拡張していく分割アプローチを提案します。まず\*\*最小実用プロトタイプ（MVP）\*\*を短期間で構築し、その後に機能拡張と最適化を行うことで、リスクを抑えつつ段階的に完成度を上げます。

- **Phase 1: MVP 実装 (1 ～ 2 週目)**
  **目的:** モバイルウォレットとの基本的な接続・取引フローを実現する。
  **内容:**

  1. Fabian 氏の`cardano-peer-connect`ライブラリを導入し、ブラウザ側で CIP-45 接続を確立できるようにする。まずは優先ウォレットである**Eternl**に絞り、`web+cardano://connect`リンクを生成してウォレットアプリ起動 →P2P ハンドシェイク →API 注入までの一連の処理を実装します。プロジェクトに既にインストール済みの依存関係を有効化し、接続用のユーティリティ（例: `connectToWallet(walletName)`）関数を整備します。
  2. **UTxO/残高取得**: 接続後、注入された`window.cardano[walletName]`オブジェクトから`getUtxos()`や`getBalance()`を呼び出し、ウォレットデータを取得できることを確認します。MVP 段階では取得した UTxO をシンプルなリスト表示する程度に留め、まずデータ取得の成功に注力します。
  3. **トランザクション組立と署名**: 簡単な送金（スイープ送金）用のトランザクションを組み立て、`api.signTx()`を呼んでウォレットに署名させる処理を実装します。MVP ではダミーの送金先や少額送金でテストし、署名結果がブラウザに返ってくるところまでを目標とします。署名済み Tx を`submitTx()`で実際にネットワークに送信し、正常にブロックに取り込まれることまで確認できれば理想です。
  4. **UI/UX**: MVP 段階では簡素でも良いので、ユーザーが「モバイルウォレット接続」フローを理解できる UI を用意します。例えばウォレット選択画面にモバイル用オプション（「Eternl (モバイル)」ボタン）を追加し、押下時に上述の connect 処理を開始。適宜アラートやモーダルで「ウォレットアプリを開いて接続してください」「署名が完了したらこの画面に戻ってください」といったメッセージを表示します。
  5. **エラーハンドリング（基本）**: 接続が一定時間内に確立しなければユーザーにエラーを知らせ、再試行を促す実装を行います（例: 20 秒待って未接続なら「接続に失敗しました。リトライしてください」表示）。トランザクション署名が拒否された場合の処理（ユーザーがウォレット側でキャンセルした等）も簡単に扱います。まだ高度なリカバリは実装しませんが、失敗時に UI が固まらないよう考慮します。

- **Phase 2: 機能拡張と改善 (3 ～ 4 週目)**
  **目的:** MVP で得られた接続フローを洗練し、対応ウォレット・機能の拡大と UX の向上を図る。
  **内容:**

  1. **対応ウォレット拡大**: Eternl での動作確認が取れたら、他の優先ウォレットにも対応を検討します。もし**Flint**が WalletConnect v2 経由での接続手段を提供していれば、WalletConnect 用の UI フローを追加実装します。ユーザーが Flint を選択した場合には WalletConnect QR を表示 or Deep Link で Flint を起動し、セッション確立後に CIP-30 API 互換のオブジェクトを得る、という処理になります。これには WalletConnect ライブラリ（公開されていれば）や Flint のドキュメントに従った実装が必要です。**Yoroi**については、依然ネイティブ対応が無い場合は対象から外し、Phase 2 では Eternl + （可能なら）Flint/Typhon 系 に留めます。
  2. **UX 改善**: Phase 1 で仮実装した UI を洗練します。具体的には、接続状態の可視化（例: 接続成功後にウォレット名と残高を表示する）、ロード中のスピナー表示、ユーザー誘導文言の改善などを行います。また、ユーザーが誤ってウォレットアプリでキャンセル/閉じてしまった場合でも、再接続しやすいように**再接続ボタン**を用意するなど、失敗後のリカバリパスも UI 上に組み込みます。
  3. **機能強化**: CIP-45 経由で利用可能な API 全般についてテストし、必要に応じて MVP で省いた機能を追加実装します。例えば**報酬アドレス取得**(`getRewardAddresses()`)、**複数トランザクションの同時処理**（CIP-30 の`signTxs()`が Eternl でベータ対応）など、将来需要がありそうな機能も検証します。また、**複数 UTxO 入力**を伴う複雑なスイープトランザクションの組み立て・署名もテストし、性能上問題ないか確認します。
  4. **再接続とセッション管理**: Phase 2 では、接続セッションの永続化や自動再接続にも取り組みます。CIP-45 で使用する識別子のシードを localStorage に保存し、ユーザーがページをリロードしても以前接続したウォレットと再ペアリングできるようにします。また、通信途絶検知を行い、一定時間アイドル後にチャネルが切断された場合は UI 上でステータスを「未接続」に戻す処理などを実装します。将来的に複数ウォレットをシームレスに切り替えできるよう、グローバルな接続ステータスマネージャーを導入するのも一案です。
  5. **エラーハンドリング強化**: 多様な失敗ケースに対応します。例として、トラッカーが全てタイムアウトした場合に「ネットワーク接続を確認してください」と表示する、ウォレット側でバージョン非対応だった場合に「このウォレットはモバイル接続をサポートしていません」と案内する、などユーザーが次に取るべき行動を明示します。また、WalletConnect 導入時には接続用 URL の期限や不正 QR コード対策なども考慮します。

- **Phase 3: フル機能実装と将来展望 (将来リリース)**
  **目的:** Cardano モバイル接続の最良のユーザー体験を提供し、将来的な拡張にも備える。
  **内容:**

  1. **全ウォレットサポート**: Cardano エコシステム内でモバイルアプリを提供する主要ウォレットすべてに対応することを目指します。将来**Yoroi**が独自に CIP-45 や WalletConnect に対応した際には速やかに実装に組み込みます。**Lace モバイル**（提供開始時）や、新興ウォレットにもアンテナを張り、業界標準に準拠していれば随時追加します。
  2. **クロスデバイス対応**: Phase 3 では「PC のブラウザ dApp」と「携帯のウォレット」間を繋ぐケースもサポートします。具体的には、CIP-45 の**QR コード経由**接続です。dApp 側で QR コードを生成し、ユーザーがモバイルウォレットアプリでスキャンすることで、異なるデバイス間でも WebRTC 接続を確立できます（この場合も基本的には同じプロトコルが動作）。これにより、PC で dApp を使いながら携帯ウォレットで署名する、といった要望にも応えられます。
  3. **ユーザー体験の極大化**: 接続から取引完了までのフローを極力スムーズにし、可能であれば**ワンクリック**または**ワンスキャン**で完結する UI を追求します。例えば初回接続時にウォレットを記憶し、次回からはボタン一つで再接続できるようにする、署名要求時に自動でウォレットアプリを開く（ユーザーの操作を最小化）などの工夫です。
  4. **高級機能・セキュリティ**: ハードウェアウォレット連携やマルチシグなど、高度な機能についても将来要件次第で検討します。また、CIP-45 提案で議論された**アイデンティコン表示**などのフィッシング対策も余裕があれば取り入れます。これは接続するウォレットの識別情報（公開鍵のハッシュ）からアバター画像を生成し、ユーザーに「どのウォレットと接続しているか」を視覚的に示すものです。セキュリティと UX 向上のため、こうした細部にも取り組みます。

- **フェーズごとの成果とフォールバック:**
  Phase 1 終了時点で、ユーザーは**Eternl モバイルで接続 →UTxO 確認 → 送金トランザクション署名**という一連の操作を行える状態となります。これは最低限の目標達成であり、この時点でモバイル対応版 dApp としてリリース可能です。Phase 2 では対応ウォレット増加と使い勝手向上により、**より多くのユーザーがストレスなく利用できる状態**を目指します。Phase 3 は理想形で、プロジェクト期間内に全て実現する必要はありませんが、ロードマップとして描いておきます。なお各フェーズにおいて、もし計画した機能が難航した場合は、**優先度に応じてスコープ調整**を行います（例えば Phase 2 で WalletConnect 統合が間に合わなければ、代替として「Yoroi ユーザー向けに内蔵ブラウザ利用を案内する」等の措置を取る）。常に\*\*グレースフルデグラデーション（優雅な機能低下）\*\*を意識し、最悪でもユーザーが元のデスクトップ手段などで代替できるよう留意します。

## リスク評価と緩和策

CIP-45 モバイル接続を導入するにあたり、考えられる主なリスクとその対策を整理します。

- **技術的リスク: P2P 接続の不安定さ**
  _内容:_ WebRTC 接続が何らかの理由で確立できない、途中で切断される、といった事態です。原因としてはユーザーのネットワーク環境（ファイアウォールや NAT の厳しさ、公衆 Wi-Fi の制限など）、トラッカーサーバーの障害、モバイル OS によるバックグラウンド制限など様々考えられます。特に初回接続が成立しないとユーザー体験を大きく損ねます。
  _緩和策:_ 接続処理に**再試行ロジック**を組み込みます。例えば最初のトライで失敗したらトラッカーリストを変えて 2 回目を試す、一定時間待ってウォレットアプリを自動再起動させる（深刻な場合）などです。また、ユーザーへの**ガイダンス強化**も重要です。「接続に時間がかかっています...もうしばらくお待ちください」「VPN をオフにして再度お試しください」といったメッセージを適切に出し、不安を和らげます。さらに、最悪接続できない場合の**代替案提示**も検討します（例: 「このウォレットでの自動接続がうまくいかない場合、ウォレット内蔵ブラウザから当サイトを開く方法があります」等）。

- **互換性リスク: ウォレット非対応によるユーザー取りこぼし**
  _内容:_ ユーザーが使用しているウォレットが CIP-45 や WalletConnect に対応しておらず、接続できないケースです。特に Yoroi モバイル利用者などが該当します。そうしたユーザーはモバイル dApp を利用できず離脱してしまう可能性があります。
  _緩和策:_ **代替手段の提示**が不可欠です。例えば、Yoroi ユーザーには「現在 Yoroi モバイルはブラウザ連携をサポートしていません。PC 版 Yoroi または Eternl モバイルをご利用いただくか、Yoroi ウォレット内の dApp ブラウザ機能（※存在する場合）で本サービスを開いてください」と案内します。幸い、Eternl は App Store/Play Store から入手可能でインストールも容易なため、**Eternl への乗り換え**を促すのも一つの手です（これはユーザーの選択に委ねますが、少なくとも案内として提示します）。将来的に Yoroi 等が対応した際には速やかにサポートを追加し、そうした告知も行います。それまでの間は「モバイルでは対応ウォレット限定」という制約を明記し、ユーザーの混乱を避けます。

- **UX リスク: ユーザーが手順に迷う/煩雑に感じる**
  _内容:_ dApp とウォレットを行き来する流れは、ユーザーにとって分かりづらい恐れがあります。例えば「どのタイミングでブラウザに戻れば良いか」「ちゃんと接続できているか」など不安に感じるポイントがあります。また、深刻な場合ユーザーが「面倒だから使うのをやめよう」と離脱する可能性もあります。
  _緩和策:_ **UI 上の案内とフィードバック**を充実させます。具体的には、接続プロセスをステップ化して画面上に表示（例: 1. ウォレット起動 → 2. 接続中 → 3. 接続成功）したり、接続成功時には明確なサイン（アイコンや「✓ 接続済」テキスト）を出します。ウォレット起動の Deep Link 発行時にはモーダルを開き「ウォレットを開いて接続を許可してください。完了後、自動でこちらに戻ります」という指示を表示します。さらに、ウォレット復帰後にユーザーが確認できるよう**接続されたウォレット名やアドレスの一部**を画面に表示し、「○○ ウォレットと接続中」であることを示すようにします。署名要求の際も「ウォレットアプリで取引内容を確認・署名してください」等、都度適切なプロンプトを出します。こうした丁寧なガイダンスにより、ユーザーの迷いを減らしスムーズに操作してもらう工夫を凝らします。

- **セキュリティリスク: 悪意あるサイトや中間者攻撃**
  _内容:_ モバイル連携は便利になる反面、新たな攻撃ベクターも考慮する必要があります。不正な dApp がユーザーのウォレットに接続要求を送りつける、あるいは通信を傍受してなりすます、といったリスクです。CIP-45 では識別子（公開鍵）が通信確立前に交換されるため、この段階で盗聴されると別人が接続を横取りする可能性もゼロではありません。また dApp 側で XSS 脆弱性があると、window\.cardano オブジェクトを悪用される恐れもあります。
  _緩和策:_ **CIP-45 標準のセキュリティ手順**を遵守します。具体的には、ウォレットアプリ側で**dApp の発行元（オリジン）を検証**すること、dApp 側でもユーザーにウォレットアドレス等を確認させ承認を得ることが推奨されています。ウォレット実装（Eternl 等）はこの点に既に配慮していると思われますが、dApp 側でも例えば接続確立時にウォレット名と共に**アイデンティコン（ウォレット識別子のハッシュに基づくアイコン）**を表示し、「このウォレットと接続しています」という視覚的確認を提供します。通信経路については WebRTC 自体が DTLS 暗号化されているため改ざん耐性があります。また、公開鍵識別子が漏洩した場合でも秘密鍵は交換しない設計上、中間者攻撃は極めて起こしにくいですが、念のため**一度接続したペアに第三者が割り込めない**ことを検証します。最後に、dApp の通常の Web セキュリティ（Content Security Policy 設定や XSS 対策）も強化し、悪意あるスクリプトによりユーザーウォレット API を勝手に操作されないよう対策します。

- **保守・将来リスク: 複雑さの増大**
  _内容:_ 新しい接続方式を導入することで、コードベースが複雑化し長期保守に負荷がかかる可能性があります。特に CIP-45 + WalletConnect ハイブリッド対応する場合、両者のアップデート追随や不具合対応を並行して行う必要が出ます。また CIP やウォレット仕様の変更（例: CIP-30 API の拡張や WalletConnect 仕様変更）が将来発生した場合、その対応も必要です。
  _緩和策:_ 可能な限り**抽象化と統一的インターフェース**を導入します。理想は Cardano Foundation の提供する`connect-with-wallet`コンポーネントのように、デスクトップ/モバイル/WalletConnect を内部でスイッチしつつ外部には同じ API を提供するラッパーを用いることです。自前実装でも、例えば`WalletConnection`クラスを定義し、`connect()`, `disconnect()`, `getApi()`などの共通メソッドを持たせ、その中で接続方式の違いを吸収するよう設計します。こうしておけば将来方式が増えてもクラスを継承実装するだけで済み、既存コードへの影響を小さくできます。また、ライブラリ（peer-connect 等）は常に最新バージョンをフォローし、コミュニティで共有されるバグ修正を取り込んでいきます。ドキュメントもアップデートがある度に参照し、仕様逸脱のないようチェック体制を維持します。

## テストと検証戦略

高品質な実装のためには包括的なテストが欠かせません。以下の観点でテスト計画を立て、接続機能の検証を行います。

- **プラットフォーム別テスト:** ターゲットである**iOS Safari**と**Android Chrome**のそれぞれで接続フローをテストします。実機ないしエミュレータを用い、最新 OS だけでなく可能であれば数バージョン前の OS でも試します（例: iOS 16 系, 17 系 / Android 12, 13 など）。デバイスのスペック差による影響も見るため、ハイエンド機とローエンド機で動作確認します。

- **ウォレット別テスト:** **Eternl**ウォレットを中心に、可能な限り**複数のウォレット**で接続テストを行います。Eternl iOS/Android それぞれで: 接続 →UTxO 取得 → 送金署名の一連を実施。Flint がテスト可能であれば同様に（WalletConnect 経由の場合、正しく QR スキャン・セッション確立できるかを含め）確認します。非対応ウォレット（Yoroi 等）を選択した場合にきちんとエラーメッセージや代替案が表示されることもテストします。

- **ネットワーク環境テスト:** 様々なネットワーク状況での挙動を検証します。高速 Wi-Fi 下で問題なくとも、**低速 3G 回線**や**高遅延ネットワーク**でタイムアウトしないか確認します。WebRTC 接続に時間がかかった場合、UI 上のタイマー表示や再接続処理が正しく機能することをチェックします。また、意図的に**特定のトラッカー URL に接続させない**設定（DNS で名前解決失敗させる等）をして、他のトラッカーでフォールバックするか確認します。企業ネットワークなど**UDP 通信不可**の環境も想定し、UDP トラッカーが使えない場合でも wss トラッカーで繋がるかテストします。

- **ユーザー操作フローのテスト:** 想定ユーザー行動に沿ったテストを行います。例えば:

  - ウォレット接続要求後、ユーザーが**すぐブラウザに戻らず**20 秒ほどウォレット画面を見続けていた場合でも、その後戻れば正常に続行できるか。
  - 署名ダイアログを**キャンセル**した場合、dApp 側がエラーを検知し適切にメッセージを表示するか。
  - dApp 側で**複数回連続で接続要求**を出した場合（誤ってユーザーがボタン連打等）、ハンドシェイクが混線しないか。重複した`window.cardano`注入が起きないか。
  - 接続後にユーザーが**ブラウザをリロード**した場合、セッションが切れ新たな接続が必要であることを UI が伝えているか（もしくは自動再接続できるか）。

- **機能テスト:** CIP-45 で利用可能な各 API について単体テストを行います。`getUtxos()`で大量の UTxO がある場合でも全件取得できるか、`signTx()`で大きなサイズのトランザクション（多数の入力・マルチアセットなど）でも問題ないか、`signData()`や`submitTx()`など他のメソッドも必要に応じ実行して正常応答を確認します。**手数料計算ロジック**（残高取得 → 送金額全額指定 → 残高不足にならないか）など、スイープ送金特有のケースについてもシナリオテストします。

- **性能テスト:** 接続に要する時間や、通信のオーバーヘッドを計測します。理想目標である**30 秒未満**で接続完了が 9 割以上のケースで達成できるかを計測し、もし超過する場合はボトルネックを分析します。また、UTxO 取得にかかる時間（ウォレット側での UTxO 集合取得 → 送信所要時間）が大量 UTxO 時でも許容範囲か確認します。クライアント側の CPU やメモリ負荷もモニタし、モバイル端末で無視できない高負荷になっていないかチェックします。

- **セキュリティテスト:** 悪意あるケースを模したテストも行います。例えば、不正な識別子を持つ偽ウォレットを接続させようとして dApp 側が排除できるか（実際にはウォレット側で対応すべき部分ですが、dApp 側でも不整合が起きないかを見る）。また、ブラウザのコンソールから悪意あるスクリプトを実行して`window.cardano`オブジェクトを不正利用できないか検証します。さらに、通信ログをプロキシなどで観察し、秘匿情報が漏れていないこと（識別子以外生の鍵や署名前 TX など）は確認します。

- **ユーザビリティテスト:** 社内またはベータテスターに実際に触ってもらい、手順の分かりやすさや躓きポイントをフィードバックしてもらいます。例えば「接続ボタンを押した後どうして良いか一瞬迷った」「署名後に戻ってくる操作が分からなかった」等の意見を集め、UI メッセージ改善に活かします。テクニカルなテストと並行して、このような UX 観点の検証も重視します。

テストは可能な限り自動化も検討します。ユニットテストとしては難しい部分もありますが、モックウォレットを用意して擬似的に WebRTC 接続を張り、CIP-30 API 呼び出しのやり取りをシミュレートする、といったテスト環境を構築すれば回帰テストを効率化できます。最低でも**主要シナリオの手動テストチェックリスト**を作成し、リリース前に毎回確認する体制を整えます。

## 本番環境への導入に関する考慮事項

最後に、実際に本番運用する際に考慮すべきポイントを整理します。

- **シグナリング・トラッカーインフラ:** CIP-45 は中央サーバーレスを理念としていますが、実際には WebTorrent トラッカーという**インフラへの依存**があります。現在デフォルトで使用するトラッカーはパブリックに提供されているもの（例: `tracker.opentrackr.org`や`tracker.files.fm`等）ですが、商用サービスとしての可用性を考えると**自前のトラッカーサーバー**を用意することも検討に値します。幸い WebTorrent トラッカーはオープンソースで軽量なため、AWS や VPS 上に立てておけば非常時のバックアップになります。Eternl 等も独自ノードを持っている可能性があります。プロジェクトリリース時には、パブリックと自前両方のトラッカーを併用し、将来的に負荷増大に備える計画を立てます。なお、ユーザー数が当初は限定的であればパブリックのみでも十分動作する見込みです。

- **Deep Link とブラウザ対応:** `web+cardano://`スキームによるウォレット起動は、Safari や Chrome といった標準ブラウザでは通常問題なく機能します。しかし、**カスタムタブ**（Chrome Custom Tabs）や**一部の WebView**環境では挙動が異なる可能性があります。公式サポート対象は Safari/Chrome ですが、ユーザーが LINE や Twitter 内蔵ブラウザでリンクを開くケースも考えられます。そうした場合 Deep Link がブロックされる可能性があるため、「別のブラウザで開いてください」という案内や、そもそも内蔵ブラウザでは起動しないよう判定する処理を導入します。また、iOS では Universal Link 形式でウォレットを起動する方法も検討します（例えば`https://connect.yoroi.app`のようなウォレット固有ドメインを踏むとアプリが開く仕組み）。ウォレットごとに指定があればそれに従い、無ければカスタム URL スキームを用います。**ユーザー許可ダイアログ**（「○○ を開こうとしています 許可/キャンセル」）が出る点も事前に案内しておくと親切です。

- **エラーログ収集とモニタリング:** 本番稼働後は、実際のユーザー環境でどの程度接続成功/失敗が発生しているかをモニタリングする仕組みを用意します。アプリに埋め込んだ分析基盤（例: Sentry や Google Analytics のカスタムイベント）で、接続試行回数・成功回数、タイムアウト発生率などを記録します。特定ウォレットや特定 OS バージョンで失敗が多発していないか分析し、継続的な改善に役立てます。また、クラッシュレポートも重要です。ブラウザ側 JavaScript が何らかの理由で例外を吐いて停止するとユーザーには見えずに接続失敗となるため、その情報を収集・デバッグできるようにします。

- **スケーラビリティ:** 利用ユーザーが増えた際のスケーラビリティにも留意します。CIP-45 自体は P2P なのでユーザー増によるサーバー負荷は本質的に少ないですが、間接的に**ブロックチェーン API サーバー**への負荷（UTxO 取得時などにウォレットが内部で API アクセスする）が増えるかもしれません。ウォレットアプリ側の問題ではありますが、例えば一度に大量の dApp 接続要求があった場合にウォレットが耐えられるか、心配が残ります。Eternl は UTxO 取得にソケット接続を試みて失敗した例も過去あり、**キャッシュ戦略**や**逐次データ取得**などウォレット側で最適化が必要になる場面も想定されます。我々としては、必要以上に頻繁に API 呼び出ししない実装（キャッシュ有効活用、ユーザー操作に応じた呼び出し）を心がけ、ウォレットへの過負荷を避けます。

- **プロトコル/仕様変更への追従:** Cardano は進化の早いエコシステムです。CIP-45 および CIP-30 も将来アップデートがある可能性があります。例えば新しい署名アルゴリズム追加や、dApp 側要求の拡張（CIP-30 拡張版として提案中の CIP-95 など）です。これらに対応するため、**公式 CIP リポジトリのウォッチ**やウォレット開発コミュニティへの参加を続けます。CIP-45 提案者の Fabian 氏の発信や、関連プロジェクト（cardano-peer-connect や connect-with-wallet）のアップデートを定期的にチェックし、後れを取らないようにします。特にセキュリティ上の勧告（例えば識別子の扱い変更等）が出た場合は迅速に適用します。

- **ユーザーサポート:** 新しい接続方式導入当初は、ユーザーから質問や不具合報告が来ることが予想されます。「接続できない」「ウォレットに戻らない」等の問い合わせにスムーズに答えられるよう、**FAQ やガイド文書**を用意しておきます。公式サイトや GitHub の Wiki などにモバイル接続の手順や注意点をまとめ、ユーザー自身で解決できる情報を提供します。またサポート窓口（Discord や Telegram などコミュニティ）でもモデレーターに本件の知識共有を行い、エスカレーションしやすくします。ユーザーフィードバックから得られた改善点は迅速に次のリリースに反映し、使いやすさの向上に努めます。

- **セキュリティおよびプライバシー:** 本番運用前に、モバイル接続部分のセキュリティレビューを行います。万一第三者が不正に接続を乗っ取れないか、コード上で脆弱な箇所がないかを確認します。必要であれば外部のセキュリティ専門家に簡易な監査を依頼することも検討します。またプライバシー面では、ユーザーのウォレット識別子（公開鍵）や UTxO 情報などが当方サーバーに一切蓄積されないことを保証する旨を明示します。本方式では通信は直接ユーザー端末間で行われますが、誤解を招かないよう利用規約やヘルプにきちんと記載します。「接続にあたり、お客様の秘密鍵や資産情報が当社サーバーに送信されることはありません」といった文言です。これはユーザーの安心感に繋がります。

以上の点を踏まえ、準備と監視を怠らなければ、CIP-45 モバイルウォレット接続機能を安全かつ効果的に本番展開できると考えます。モバイル対応はユーザー体験を大きく向上させ、プロダクトの価値を高める重要なステップです。慎重に実装・検証を進めつつ、適切なリスク管理で高品質なリリースを目指します。

**参考文献:** Cardano Improvement Proposal 45 (Decentralized WebRTC dApp-Wallet Communication)、Cardano Foundation Blog「Cardano Ballot 2023」、Eternl Wallet 公式 Wiki、Catalyst Proposal「WalletConnect for Cardano」ほか.
