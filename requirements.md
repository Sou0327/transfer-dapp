# 要件定義書

## 概要

本文書は、マルチチェーン対応トークン送金分散アプリケーション（dApp）の要件を定義します。このアプリケーションは、ERC-20（Ethereum）と TRC-20（Tron）トークンの両方に対応し、MetaMask と TronLink の複数ウォレット接続、トークン残高表示、送金機能、送金履歴管理を提供するユーザーフレンドリーなインターフェースを実現します。

## 要件

### 要件 1

**ユーザーストーリー:** ユーザーとして、MetaMask と TronLink の両方のウォレットを同時に接続したい。そうすることで、Ethereum と Tron の両方のネットワークでトークン操作ができるようになる。

#### 受け入れ基準

1. ユーザーが MetaMask 接続ボタンをクリックしたとき、システムは window.ethereum 経由で MetaMask への接続を要求する
2. ユーザーが TronLink 接続ボタンをクリックしたとき、システムは window.tronWeb 経由で TronLink への接続を要求する
3. 両方のウォレットが接続されたとき、システムは各ウォレットのアカウントアドレスとネットワーク情報を表示する
4. ウォレットがインストールされていないとき、システムは適切なインストールガイドを表示する
5. ユーザーが接続要求を拒否したとき、システムはユーザーフレンドリーなメッセージで拒否を適切に処理する

### 要件 2

**ユーザーストーリー:** ユーザーとして、接続されたウォレットを個別に管理したい。そうすることで、必要に応じて特定のウォレットのみを使用できる。

#### 受け入れ基準

1. ウォレット接続状態が表示されたとき、システムは各ウォレットの接続状態を独立して表示する
2. ユーザーが特定のウォレットを切断したとき、システムは他のウォレットの接続状態に影響を与えない
3. ウォレットアカウントが変更されたとき、システムは該当するウォレットの情報のみを更新する
4. ネットワークが変更されたとき、システムは該当するウォレットのネットワーク情報を更新する

### 要件 3

**ユーザーストーリー:** ユーザーとして、ERC-20 と TRC-20 の両方のトークン残高を確認したい。そうすることで、各チェーンで利用可能なトークン数を把握できる。

#### 受け入れ基準

1. Ethereum ウォレットが接続されたとき、システムは ERC-20 トークンの残高を取得し表示する
2. Tron ウォレットが接続されたとき、システムは TRC-20 トークンの残高を取得し表示する
3. 残高が表示されたとき、システムは 15 秒ごとのポーリングで各チェーンの残高を更新する
4. 残高取得が失敗したとき、システムはエラーメッセージを表示し再試行する
5. チェーンを切り替えたとき、システムは選択されたチェーンのトークン残高を表示する

### 要件 4

**ユーザーストーリー:** ユーザーとして、ERC-20 と TRC-20 トークンを統一されたインターフェースで送金したい。そうすることで、チェーンに関係なく同じ操作で送金できる。

#### 受け入れ基準

1. ユーザーがチェーンを選択したとき、システムは選択されたチェーンに対応するトークンリストを表示する
2. ユーザーがトークンと受信者アドレス、金額を入力したとき、システムは選択されたチェーンの形式で入力を検証する
3. ERC-20 送金が実行されたとき、システムは Ethers.js を使用して Ethereum ネットワークで送金を実行する
4. TRC-20 送金が実行されたとき、システムは TronWeb を使用して Tron ネットワークで送金を実行する
5. 送金が成功したとき、システムは成功通知を表示し残高を更新し履歴に記録する

### 要件 5

**ユーザーストーリー:** ユーザーとして、過去の送金履歴を確認したい。そうすることで、送金の記録を追跡し管理できる。

#### 受け入れ基準

1. 送金が完了したとき、システムは送金履歴にトランザクション情報を保存する
2. ユーザーが履歴を表示したとき、システムは日時、チェーン、トークン、金額、受信者、ステータスを表示する
3. 履歴が表示されたとき、システムは最新の送金から順番に表示する
4. ユーザーがトランザクションハッシュをクリックしたとき、システムは対応するブロックエクスプローラーを開く
5. 履歴データが多いとき、システムはページネーションまたは無限スクロールで表示する

### 要件 6

**ユーザーストーリー:** ユーザーとして、送金履歴をフィルタリングして検索したい。そうすることで、特定の送金を素早く見つけることができる。

#### 受け入れ基準

1. ユーザーがチェーンフィルターを選択したとき、システムは選択されたチェーンの送金のみを表示する
2. ユーザーがトークンフィルターを選択したとき、システムは選択されたトークンの送金のみを表示する
3. ユーザーが日付範囲を指定したとき、システムは指定された期間の送金のみを表示する
4. ユーザーがアドレスで検索したとき、システムは送信者または受信者が一致する送金を表示する
5. ユーザーがステータスフィルターを選択したとき、システムは選択されたステータスの送金のみを表示する

### 要件 7

**ユーザーストーリー:** ユーザーとして、送金履歴をエクスポートしたい。そうすることで、外部で記録を管理できる。

#### 受け入れ基準

1. ユーザーがエクスポートボタンをクリックしたとき、システムは履歴データを CSV 形式でダウンロードする
2. エクスポートされたデータには、日時、チェーン、トークン、金額、送信者、受信者、ハッシュ、ステータスが含まれる
3. フィルターが適用されているとき、システムはフィルター結果のみをエクスポートする
4. エクスポートが完了したとき、システムは成功メッセージを表示する

### 要件 8

**ユーザーストーリー:** ユーザーとして、チェーン固有のアドレス形式を正しく検証してほしい。そうすることで、間違ったチェーンへの送金を防げる。

#### 受け入れ基準

1. Ethereum が選択されたとき、システムは 0x で始まる 42 文字のアドレス形式を検証する
2. Tron が選択されたとき、システムは T で始まる Base58 形式のアドレスを検証する
3. 無効なアドレスが入力されたとき、システムはチェーン固有のエラーメッセージを表示する
4. 異なるチェーンのアドレスが入力されたとき、システムは警告メッセージを表示する

### 要件 9

**ユーザーストーリー:** ユーザーとして、各チェーンのネットワーク状態を確認したい。そうすることで、送金前にネットワークの状況を把握できる。

#### 受け入れ基準

1. Ethereum ネットワークが接続されたとき、システムはガス価格とブロック番号を表示する
2. Tron ネットワークが接続されたとき、システムはエネルギー価格とブロック番号を表示する
3. ネットワークが混雑しているとき、システムは警告メッセージを表示する
4. ネットワーク情報が更新されたとき、システムは 30 秒ごとに最新情報を取得する

### 要件 10

**ユーザーストーリー:** ユーザーとして、送金時の手数料を事前に確認したい。そうすることで、送金コストを把握してから実行できる。

#### 受け入れ基準

1. Ethereum 送金時、システムはガス制限とガス価格から手数料を計算し表示する
2. Tron 送金時、システムはエネルギーとバンド幅から手数料を計算し表示する
3. 手数料が高額なとき、システムは警告メッセージを表示する
4. 手数料計算が失敗したとき、システムはエラーメッセージを表示し推定値を提供する

### 要件 11

**ユーザーストーリー:** ユーザーとして、非標準的なトークンでも安全に送金したい。そうすることで、様々なトークンで取引できる。

#### 受け入れ基準

1. ERC-20 で transfer が false を返すトークンのとき、システムは戻り値をチェックして適切に処理する
2. TRC-20 で異常な動作をするトークンのとき、システムは警告を表示するが送金は実行可能にする
3. 非標準トークンが検出されたとき、システムはユーザーに警告を表示し確認を求める
4. 送金後の残高確認で不整合が検出されたとき、システムは警告を表示する

### 要件 12

**ユーザーストーリー:** ユーザーとして、レスポンシブでアクセシブルなインターフェースを使用したい。そうすることで、デバイスに関係なく快適に操作できる。

#### 受け入れ基準

1. アプリケーションが表示されたとき、システムはデスクトップとモバイルで適切に動作する
2. ダークモードが切り替えられたとき、システムは全てのコンポーネントでテーマを適用する
3. キーボードナビゲーションが使用されたとき、システムは適切にフォーカス管理を行う
4. スクリーンリーダーが使用されたとき、システムは適切な ARIA 属性を提供する

### 要件 13

**ユーザーストーリー:** ユーザーとして、送金履歴データを安全に管理してほしい。そうすることで、プライバシーを保護しながら履歴を利用できる。

#### 受け入れ基準

1. 履歴データが保存されるとき、システムはローカルストレージに暗号化して保存する
2. 機密情報が含まれるとき、システムは秘密鍵や署名データを保存しない
3. ユーザーが履歴をクリアしたとき、システムは全ての履歴データを完全に削除する
4. データが破損したとき、システムは安全にリセットし新しい履歴を開始する

### 要件 14

**ユーザーストーリー:** 開発者として、包括的なテストカバレッジを持ちたい。そうすることで、マルチチェーン機能が信頼性を持って動作する。

#### 受け入れ基準

1. ウォレット接続コンポーネントがテストされたとき、システムは MetaMask と TronLink の両方をカバーする
2. 送金フォームがテストされたとき、システムは ERC-20 と TRC-20 の両方の送金をテストする
3. 履歴機能がテストされたとき、システムは保存、表示、フィルタリング、エクスポートをテストする
4. テストが実行されたとき、システムは外部依存関係を適切にモックする

### 要件 15

**ユーザーストーリー:** ユーザーとして、送金の進行状況をリアルタイムで確認したい。そうすることで、送金の状態を把握できる。

#### 受け入れ基準

1. 送金が開始されたとき、システムは進行状況インジケーターを表示する
2. トランザクションが送信されたとき、システムはトランザクションハッシュを表示する
3. 確認待ちのとき、システムは現在の確認数と必要確認数を表示する
4. 送金が完了したとき、システムは成功メッセージと最終結果を表示する
5. 送金が失敗したとき、システムは詳細なエラー情報と対処法を表示する
